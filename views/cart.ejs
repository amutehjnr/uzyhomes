<!-- views/cart.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="UZYHOMES Shopping Cart - Your selected quiet luxury bedding, interiors, and décor items.">
    <title><%= title || 'Shopping Cart' %> — UZYHOMES</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/cart.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    
    <style>
        /* Cart specific styles */
        .cart-item {
            transition: opacity 0.3s ease, transform 0.3s ease;
            border-bottom: 1px solid #f0f0f0;
            padding: 1.5rem 0;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-image {
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .cart-item-title {
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }
        
        .cart-item-title a {
            color: #1a1a1a;
            text-decoration: none;
        }
        
        .cart-item-title a:hover {
            text-decoration: underline;
        }
        
        .cart-item-collection {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        
        .cart-item-options {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .cart-item-options span {
            margin-right: 1rem;
            display: inline-block;
            margin-bottom: 0.25rem;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #dee2e6;
            border-radius: 30px;
            overflow: hidden;
            width: fit-content;
            background: white;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1a1a;
        }
        
        .quantity-btn:hover:not(:disabled) {
            background: #f8f9fa;
        }
        
        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 60px;
            height: 40px;
            border: none;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            text-align: center;
            -moz-appearance: textfield;
            font-size: 1rem;
        }
        
        .quantity-input:focus {
            outline: none;
        }
        
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .cart-item-price .price {
            font-size: 1.1rem;
            font-weight: 500;
            color: #1a1a1a;
        }
        
        .original-price {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .btn-remove {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #dee2e6;
            background: transparent;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        
        .btn-remove:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        .order-summary {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            position: sticky;
            top: 100px;
        }
        
        .summary-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .summary-divider {
            height: 1px;
            background: #dee2e6;
            margin: 1rem 0;
        }
        
        .summary-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .summary-note {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .summary-note p {
            margin-bottom: 0.5rem;
        }
        
        .payment-icon {
            font-size: 1.5rem;
            color: #6c757d;
            transition: color 0.2s ease;
        }
        
        .payment-icon:hover {
            color: #1a1a1a;
        }
        
        .recommended-product {
            transition: transform 0.3s ease;
        }
        
        .recommended-product:hover {
            transform: translateY(-5px);
        }
        
        .recommended-image {
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
            aspect-ratio: 1 / 1;
        }
        
        .recommended-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .recommended-product:hover .recommended-image img {
            transform: scale(1.05);
        }
        
        .recommended-info h4 {
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
            color: #1a1a1a;
        }
        
        .recommended-price {
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }
        
        .btn-add-to-cart {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid #1a1a1a;
            border-radius: 30px;
            color: #1a1a1a;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn-add-to-cart:hover:not(:disabled) {
            background: #1a1a1a;
            color: white;
        }
        
        .btn-add-to-cart:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-cart {
            padding: 4rem 0;
        }
        
        .empty-cart-icon {
            color: #dee2e6;
        }
        
        /* Loading spinner */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        
        /* Notification container */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        /* Cart count badge */
        .cart-count {
            background: #1a1a1a;
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            position: absolute;
            top: -8px;
            right: -8px;
            min-width: 20px;
            text-align: center;
        }
        
        /* Applied coupon styles */
        .applied-coupon {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .coupon-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 0.5rem;
        }
        
        /* Quantity label for mobile */
        .quantity-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 767px) {
            .cart-item {
                padding: 1rem 0;
            }
            
            .cart-item-image {
                max-width: 100px;
            }
            
            .btn-remove {
                margin-left: 0;
            }
            
            .order-summary {
                position: static;
                margin-top: 2rem;
            }
            
            .quantity-control {
                margin-bottom: 0.5rem;
            }
            
            .cart-item-price {
                text-align: left !important;
            }
        }
    </style>
</head>
<body class="quiet-luxury">
    <%- include('partials/header') %>

    <!-- Cart Header -->
    <section class="cart-header section-py" style="padding-top: 120px;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1 class="display-5 mb-3">Your Shopping Cart</h1>
                    <p class="lead" id="cart-header-text">
                        <% if (!cart || !cart.items || cart.items.length === 0) { %>
                            Your cart is empty
                        <% } else { %>
                            You have <span id="cart-items-count"><%= cart.items.reduce((total, item) => total + (item.quantity || 0), 0) %></span> item(s) in your cart
                        <% } %>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Cart Content -->
    <section class="section-py" style="padding-top: 0;">
        <div class="container">
            <% if (!cart || !cart.items || cart.items.length === 0) { %>
                <!-- Empty Cart -->
                <div class="empty-cart text-center py-5">
                    <div class="empty-cart-icon mb-4">
                        <i class="fas fa-shopping-bag fa-4x text-muted"></i>
                    </div>
                    <h3 class="mb-3">Your cart is empty</h3>
                    <p class="text-muted mb-4">Discover our quiet luxury collection</p>
                    <a href="/bedding" class="btn btn-dark">
                        <i class="fas fa-arrow-left me-2"></i>Start Shopping
                    </a>
                </div>
            <% } else { %>
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Cart Items -->
                        <div class="cart-items">
                            <% cart.items.forEach((item, index) => { %>
                                <% 
                                    // Safely access product data
                                    const product = item.product || {};
                                    const price = product.discountPrice || product.price || 0;
                                    const itemTotal = price * (item.quantity || 1);
                                    const itemId = item._id || item.productId || `temp-${index}`;
                                    const productId = product._id || item.productId;
                                    const stock = product.stock || 999;
                                    const imageUrl = product.images && product.images.length > 0 
                                        ? product.images[0].url 
                                        : '/images/placeholder.jpg';
                                %>
                                <div class="cart-item" data-item-id="<%= itemId %>" data-product-id="<%= productId %>" data-item-index="<%= index %>">
                                    <div class="row align-items-center">
                                        <div class="col-md-2 col-4">
                                            <div class="cart-item-image">
                                                <img src="<%= imageUrl %>" 
                                                     alt="<%= product.name || 'Product' %>" 
                                                     class="img-fluid"
                                                     loading="lazy">
                                            </div>
                                        </div>
                                        <div class="col-md-5 col-8">
                                            <div class="cart-item-details">
                                                <h3 class="cart-item-title">
                                                    <a href="/product/<%= productId %>" class="text-decoration-none text-dark">
                                                        <%= product.name || 'Product' %>
                                                    </a>
                                                </h3>
                                                <p class="cart-item-collection"><%= product.category || 'Uncategorized' %></p>
                                                <div class="cart-item-options">
                                                    <% if (product.specifications) { %>
                                                        <% if (product.specifications.size) { %>
                                                            <span><i class="fas fa-ruler me-1"></i>Size: <%= product.specifications.size %></span>
                                                        <% } %>
                                                        <% if (product.specifications.color) { %>
                                                            <span><i class="fas fa-palette me-1"></i>Color: <%= product.specifications.color %></span>
                                                        <% } %>
                                                        <% if (product.specifications.material) { %>
                                                            <span><i class="fas fa-tag me-1"></i>Material: <%= product.specifications.material %></span>
                                                        <% } %>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-6 mt-3 mt-md-0">
                                            <div class="cart-item-quantity">
                                                <div class="quantity-label d-md-none">Quantity:</div>
                                                <div class="quantity-control">
                                                    <button class="quantity-btn" type="button" data-action="decrease" aria-label="Decrease quantity" <%= item.quantity <= 1 ? 'disabled' : '' %>>−</button>
                                                    <input type="number" class="quantity-input" 
                                                           value="<%= item.quantity || 1 %>" 
                                                           min="1" 
                                                           max="<%= stock %>"
                                                           data-product-stock="<%= stock %>"
                                                           data-item-id="<%= itemId %>"
                                                           aria-label="Quantity"
                                                           readonly>
                                                    <button class="quantity-btn" type="button" data-action="increase" aria-label="Increase quantity" <%= item.quantity >= stock ? 'disabled' : '' %>>+</button>
                                                </div>
                                                <% if (stock < 10) { %>
                                                    <small class="text-warning d-block mt-1">Only <%= stock %> left</small>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-6 mt-3 mt-md-0">
                                            <div class="cart-item-price text-md-end">
                                                <div class="quantity-label d-md-none">Price:</div>
                                                <span class="price">₦<%= Number(price).toLocaleString() %></span>
                                                <% if (product.discountPrice) { %>
                                                    <span class="original-price text-muted text-decoration-line-through d-block">
                                                        ₦<%= Number(product.price).toLocaleString() %>
                                                    </span>
                                                <% } %>
                                            </div>
                                        </div>
                                        <div class="col-md-1 col-12 mt-3 mt-md-0">
                                            <div class="cart-item-remove text-md-end">
                                                <button class="btn-remove remove-item-btn" data-item-id="<%= itemId %>" aria-label="Remove item">
                                                   <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                        
                        <!-- Cart Actions -->
                        <div class="cart-actions mt-5">
                            <div class="row">
                                <div class="col-md-6">
                                    <a href="/bedding" class="btn btn-outline-dark">
                                        <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                                    </a>
                                </div>
                                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                                    <button class="btn btn-outline-dark" id="clearCartBtn">
                                       <i class="fas fa-trash-alt me-2"></i>Clear Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Promo Code -->
                        <div class="promo-code mt-5">
                            <h4 class="mb-3">Have a Promo Code?</h4>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="couponCode" 
                                               placeholder="Enter promo code"
                                               value="<%= cart.couponCode || '' %>"
                                               aria-label="Coupon code">
                                        <button class="btn btn-outline-dark" type="button" id="applyCouponBtn">
                                            Apply
                                        </button>
                                    </div>
                                    
                                    <!-- Coupon Message Display -->
                                    <div id="coupon-message" class="mt-3"></div>
                                    
                                    <% if (cart.couponCode) { %>
                                        <div class="applied-coupon mt-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="coupon-badge">Applied</span>
                                                    <strong><%= cart.couponCode %></strong>
                                                    <span class="text-success ms-2">-₦<%= Number(cart.couponDiscount || 0).toLocaleString() %></span>
                                                </div>
                                                <button class="btn btn-sm btn-outline-danger remove-coupon-btn">
                                                   <i class="fas fa-times"></i> Remove
                                                </button>
                                            </div>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Summary -->
                    <div class="col-lg-4 mt-5 mt-lg-0">
                        <div class="order-summary">
                            <h3 class="summary-title">Order Summary</h3>
                            
                            <div class="summary-items">
                                <div class="summary-item">
                                    <span>Subtotal (<span id="summary-item-count"><%= cart.items.reduce((total, item) => total + (item.quantity || 0), 0) %></span> items)</span>
                                    <span id="summary-subtotal">₦<%= Number(cart.subtotal || 0).toLocaleString() %></span>
                                </div>
                                <div class="summary-item">
                                    <span>Tax (8%)</span>
                                    <span id="summary-tax">₦<%= Number(cart.tax || 0).toLocaleString() %></span>
                                </div>
                                <div class="summary-item">
                                    <span>Shipping</span>
                                    <span id="summary-shipping">
                                        <% if (cart.shippingCost === 0 || cart.shipping === 0) { %>
                                            <span class="text-success">Free</span>
                                        <% } else { %>
                                            ₦<%= Number(cart.shippingCost || cart.shipping || 0).toLocaleString() %>
                                        <% } %>
                                    </span>
                                </div>
                                <% if (cart.couponDiscount && cart.couponDiscount > 0) { %>
                                    <div class="summary-item" id="discount-row">
                                        <span>Discount (<%= cart.couponCode %>)</span>
                                        <span class="text-success" id="summary-discount">-₦<%= Number(cart.couponDiscount).toLocaleString() %></span>
                                    </div>
                                <% } %>
                                <div class="summary-divider"></div>
                                <div class="summary-total">
                                    <span>Total</span>
                                    <span class="total-amount" id="summary-total">₦<%= Number(cart.total || 0).toLocaleString() %></span>
                                </div>
                            </div>
                            
                            <div class="summary-note">
                                <p><i class="fas fa-info-circle me-2"></i>Shipping calculated at checkout</p>
                                <p><i class="fas fa-undo me-2"></i>30-day return policy</p>
                                <p><i class="fas fa-shield-alt me-2"></i>Secure checkout</p>
                            </div>
                            
                            <a href="/cart/checkout" class="btn btn-dark btn-lg w-100 mt-4" id="checkout-btn">
                                <i class="fas fa-lock me-2"></i>Proceed to Checkout
                            </a>
                            
                            <div class="payment-methods mt-4">
                                <p class="text-center mb-3">We accept</p>
                                <div class="d-flex justify-content-center gap-4">
                                    <i class="fab fa-cc-visa fa-2x payment-icon"></i>
                                    <i class="fab fa-cc-mastercard fa-2x payment-icon"></i>
                                    <i class="fab fa-cc-amex fa-2x payment-icon"></i>
                                    <i class="fab fa-cc-paypal fa-2x payment-icon"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Support -->
                        <div class="customer-support mt-5">
                            <h4 class="mb-3">Need Help?</h4>
                            <div class="support-contact bg-light p-4 rounded">
                                <p class="mb-3">
                                    <i class="fas fa-phone me-2 text-dark"></i>
                                    <a href="tel:+2347047511911" class="text-decoration-none text-dark">+234 704 751 1911</a>
                                </p>
                                <p class="mb-3">
                                    <i class="fas fa-envelope me-2 text-dark"></i>
                                    <a href="mailto:support@uzyhomes.com" class="text-decoration-none text-dark">support@uzyhomes.com</a>
                                </p>
                                <p class="mb-0">
                                    <i class="fas fa-clock me-2 text-dark"></i>
                                    Mon-Fri 9am-6pm, Sat 10am-4pm
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    </section>

    <!-- Recommended Products -->
    <section class="section-py bg-light">
        <div class="container">
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h3 class="section-title">You Might Also Like</h3>
                    <p class="text-muted">Complete your collection with these pieces</p>
                </div>
            </div>
            
            <div class="row g-4" id="recommended-products">
                <!-- Loading state -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading recommendations...</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <%- include('partials/footer') %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/auth.js"></script> 
    <script src="/js/cart.js"></script>

    <!-- Initialize cart on page load -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update cart count on page load
            if (typeof updateCartCount === 'function') {
                updateCartCount();
            }
            
            // Initialize any additional cart functionality
            console.log('Cart page loaded');
        });
    </script>
</body>
</html>