<!-- views/account.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account â€” UZYHOMES</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/account.css">
</head>
<body class="quiet-luxury">

    <!-- Add this right after <body> and before <%- include('partials/header') %> -->
<script>
  // Log URL parameters for debugging
  console.log('Account page loaded');
  console.log('URL:', window.location.href);
  console.log('Search params:', window.location.search);
  
  const urlParams = new URLSearchParams(window.location.search);
  console.log('payment param:', urlParams.get('payment'));
  console.log('order param:', urlParams.get('order'));
  console.log('error param:', urlParams.get('error'));
</script>
    <%- include('partials/header') %>

    <!-- PAYMENT STATUS MESSAGES - ADD THIS SECTION -->
    <% 
        // Get query parameters from server.js
        const paymentStatus = locals.payment_status || query?.payment;
        const orderId = locals.order_id || query?.order;
        const errorMsg = locals.error || query?.error;
    %>
    
    <% if (paymentStatus === 'success') { %>
        <div class="container mt-4">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Payment Successful!</strong> Your order has been placed and payment confirmed.
                <% if (orderId) { %>
                    <a href="/orders/<%= orderId %>" class="alert-link ms-2">View Order</a>
                <% } %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    <% } else if (paymentStatus === 'failed') { %>
        <div class="container mt-4">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Payment Failed!</strong> 
                <%= errorMsg ? decodeURIComponent(errorMsg) : 'There was an issue with your payment. Please try again.' %>
                <% if (orderId) { %>
                    <a href="/orders/<%= orderId %>/retry" class="alert-link ms-2">Retry Payment</a>
                <% } %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    <% } %>

    <section class="account-section section-py">
        <div class="container">
            <div class="row">
                <div class="col-lg-3">
                    <!-- Account Sidebar (your existing sidebar) -->
                    <div class="account-sidebar">
                        <div class="user-info text-center mb-4">
                            <div class="user-avatar mb-3">
                                <i class="fas fa-user-circle fa-4x"></i>
                            </div>
                            <h5 id="userName"></h5>
                            <p class="text-muted" id="userEmail"></p>
                        </div>
                        
                        <div class="nav flex-column nav-pills" id="accountTabs" role="tablist">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </button>
                            <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button">
                                <i class="fas fa-shopping-bag me-2"></i>Orders
                            </button>
                            <button class="nav-link" id="profile-tab" data-bs-toggle="pill" data-bs-target="#profile" type="button">
                                <i class="fas fa-user me-2"></i>Profile
                            </button>
                            <button class="nav-link" id="password-tab" data-bs-toggle="pill" data-bs-target="#password" type="button">
                                <i class="fas fa-lock me-2"></i>Change Password
                            </button>
                            <button class="nav-link" id="addresses-tab" data-bs-toggle="pill" data-bs-target="#addresses" type="button">
                                <i class="fas fa-map-marker-alt me-2"></i>Addresses
                            </button>
                            <button class="nav-link" id="wishlist-tab" data-bs-toggle="pill" data-bs-target="#wishlist" type="button">
                                <i class="fas fa-heart me-2"></i>Wishlist
                            </button>
                            <button class="nav-link" id="logout-tab" type="button">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-9">
                    <div class="account-content">
                        <div class="tab-content" id="accountTabContent">
                            <!-- Dashboard -->
                            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                                <h4 class="mb-4">Welcome back, <span id="dashboardName"></span>!</h4>
                                
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="dashboard-card">
                                            <div class="card-body">
                                                <h5>Recent Orders</h5>
                                                <div id="recentOrders"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="dashboard-card">
                                            <div class="card-body">
                                                <h5>Account Overview</h5>
                                                <div id="accountOverview"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Settings -->
                            <div class="tab-pane fade" id="profile" role="tabpanel">
                                <h4 class="mb-4">Profile Settings</h4>
                                
                                <div id="profileAlert" style="display: none;"></div>
                                
                                <form id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-4">
                                            <label for="profileFirstName" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="profileFirstName" required>
                                        </div>
                                        <div class="col-md-6 mb-4">
                                            <label for="profileLastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="profileLastName" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="profileEmail" class="form-label">Email Address</label>
                                        <input type="email" class="form-control" id="profileEmail" readonly>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="profilePhone" class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="profilePhone">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-dark" id="updateProfileBtn">
                                        <span id="updateProfileText">Update Profile</span>
                                        <span id="updateProfileSpinner" style="display: none;">
                                            <span class="spinner-border spinner-border-sm"></span> Updating...
                                        </span>
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Change Password -->
                            <div class="tab-pane fade" id="password" role="tabpanel">
                                <h4 class="mb-4">Change Password</h4>
                                
                                <div id="passwordAlert" style="display: none;"></div>
                                
                                <form id="changePasswordForm">
                                    <div class="mb-4">
                                        <label for="currentPassword" class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="newPassword" class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirmNewPassword" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-dark" id="changePasswordBtn">
                                        <span id="changePasswordText">Change Password</span>
                                        <span id="changePasswordSpinner" style="display: none;">
                                            <span class="spinner-border spinner-border-sm"></span> Updating...
                                        </span>
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Orders -->
                            <div class="tab-pane fade" id="orders" role="tabpanel">
                                <h4 class="mb-4">My Orders</h4>
                                <div id="ordersList"></div>
                            </div>
                            
                            <!-- Addresses -->
                            <div class="tab-pane fade" id="addresses" role="tabpanel">
                                <h4 class="mb-4">My Addresses</h4>
                                <div id="addressesList"></div>
                            </div>
                            
                            <!-- Wishlist -->
                            <div class="tab-pane fade" id="wishlist" role="tabpanel">
                                <h4 class="mb-4">My Wishlist</h4>
                                <div id="wishlistItems"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <%- include('partials/footer') %>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/auth.js"></script>
    <script src="/js/cart.js"></script>
    <script src="/js/account.js"></script>
    
    <script>
        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });
    </script>
</body>
</html>